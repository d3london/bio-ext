import json

import requests

url = "http://localhost:9991/v1/chat/completions"

headers = {"Content-Type": "application/json"}
SYSTEM_PROMPT = """You are an expert oncology information extraction system. Your task is to convert oncology clinic letters into structured JSON data following a specific schema. Key principles:\n* Extract comprehensive information that match the schema field definitions while maintaining perfect accuracy\n* Only include explicitly stated information - never infer\n* Only extract dates when directly connected to events\n* Preserve original clinical terminology without standardisation\n* Pay particular attention to:\n   - Main cancer diagnosis details and timeline\n   - Treatment responses and changes\n   - Current clinical status and plans\n\nThe output schema is designed to capture:\n* primary_cancer: Main cancer details and comprehensive timeline\n* other_cancers: Any additional cancer diagnoses\n* patient_facts: Current clinical information\n* status_updates: Latest developments and plans\n\nNow: please explore the following schema, and the given example, very carefully:\n{\"schema_version\":\"2.0\",\"schema_rules\":[\"Extract complete phrases with full clinical context\",\"Preserve original clinical language and abbreviations, do not standardise\",\"Include any relevant qualifiers and context, including measures of severity\",\"Extract dates as year/month only where available and clearly attached to concept\",\"Exclude fields where information missing - do not infer or make up new information\"],\"schema_structure\":{\"primary_cancer\":{\"description\":\"Main primary cancer and related facts that are the main subject of letter. Populate fields only where information present.\",\"fields\":{\"site\":\"Primary main organ site or topography (e.g. - ovary, breast, brain, lung, etc) and more detailed localisation (e.g. right, upper lobe, cerebellum). Confirmed diagnosis only. For example - do not populate if patient is referred for suspicion of diagnosis and further invesigation, or if letter does not refer to a primary main cancer organ site\",\"year\":\"Year of initial diagnosis (YYYY) if given\",\"month\":\"Month of initial diagnosis (1-12) if given\",\"metastases\":\"Location of any confirmed metastases, including nodal disease\",\"tnm_stage\":\"Current TNM staging for main cancer. Do NOT infer.\",\"other_stage\":\"Other cancer staging, e.g. stage 1,2,3,4. Do NOT infer.\",\"histopathology_status\":\"Morphology (e.g. if adenocarcinoma, squamous cell carcinoma, small cell carcinoma, etc etc), and other histopathological findings\",\"biomarker_status\":\"Status of any identifying biomarkers for main cancer, including genomic biomarkers (e.g. HER2, BRCA, BRAF, Microsatellite instability, etc etc)\"},\"cancer_timeline\":{\"description\":[\"Timeline of events for main primary cancer leading to the present consultation.\",\"treatment_systemic_start captures whereever a new systemic therapy regimen, e.g. chemo or immuno, was commenced\",\"treatment_systemic_change captures pausing, dose reduction, stopping of systemic therapy\",\"treatment_radiotherapy and treatment_surgery capture these types of treatment\",\"anatomical_finding captures spread to anatomical locations\",\"laboratory_finding captures lab or pathology results\",\"other_progress_or_event captures general events\",\"clinical_trial_update captures trial related events\"],\"cardinality\":\"multiple\",\"allowed_types\":[\"treatment_systemic_start\",\"treatment_systemic_change\",\"treatment_radiotherapy\",\"treatment_surgery\",\"anatomical_finding\",\"laboratory_finding\",\"other_progress_or_event\",\"clinical_trial_update\"],\"fields\":{\"type\":\"Event type from allowed_types\",\"value\":\"Extracted event text\",\"year\":\"Year of event (YYYY) if given\",\"month\":\"Month of event (1-12) if given\"}}},\"other_cancers\":{\"description\":\"Array of historical cancer diagnoses and facts, if any.\",\"repeatable\":true,\"fields\":{\"site\":\"Organ site or topography, and more detailed localisation\",\"year\":\"Year of historical cancer diagnosis (YYYY) if given\",\"month\":\"Month of historical diagnosis (1-12) if given\",\"metastases\":\"Location of confirmed metastases, including nodal disease\",\"tnm_stage\":\"TNM staging for historical cancer\",\"other_stage\":\"Other cancer staging\",\"histopathology_status\":\"Histopathological classification, morphology, and findings for historical cancer\",\"biomarker_status\":\"Status of any identifying biomarkers for historical cancer\",\"latest_situation\":\"Last given treatment status for historical cancer\"}},\"patient_facts\":{\"description\":\"Current, active patient information given in the letter.\",\"cardinality\":\"multiple\",\"allowed_types\":[\"comorbidity\",\"current_symptom\",\"examination_finding\",\"performance_status\",\"quality_of_life_finding\",\"investigation_finding\"],\"fields\":{\"type\":\"Type of patient fact from allowed_types\",\"value\":\"Extracted fact information\"}},\"status_updates\":{\"description\":[\"This summarises different types of updated status\"],\"cardinality\":\"multiple\",\"allowed_types\":[\"clinical_summary\",\"latest_treatment_response\",\"latest_treatment_toxicity\",\"update_to_treatment\",\"updated_patient_functional_status\",\"planned_investigation\",\"follow_up_referral\",\"death_flag\"],\"fields\":{\"type\":\"Type of new status from allowed_types\",\"value\":\"Extracted status information\"}}},\"schema_example\":{\"primary_cancer\":{\"site\":\"lung, right upper lobe\",\"year\":2024,\"month\":1,\"metastases\":\"widespread bone metastases, bilateral adrenal metastases\",\"tnm_stage\":\"T4N2M1c\",\"other_stage\":\"Stage IV\",\"histopathology_status\":\"adenocarcinoma\",\"biomarker_status\":\"EGFR mutation positive, PDL1 80%, ALK negative\",\"cancer_timeline\":[{\"type\":\"anatomical_finding\",\"value\":\"CT chest shows 6.8cm right upper lobe mass with mediastinal and hilar lymphadenopathy\",\"year\":2024,\"month\":3},{\"type\":\"anatomical_finding\",\"value\":\"PET-CT confirms FDG-avid right upper lobe primary with widespread skeletal metastases\",\"year\":2024,\"month\":3},{\"type\":\"laboratory_finding\",\"value\":\"EGFR mutation detected in circulating tumor DNA\",\"year\":2024,\"month\":3},{\"type\":\"treatment_systemic_start\",\"value\":\"Started on Osimertinib 80mg daily\",\"year\":2024,\"month\":3},{\"type\":\"treatment_radiotherapy\",\"value\":\"Completed palliative radiotherapy 20Gy in 5 fractions to symptomatic T4 vertebral metastasis\",\"year\":2024,\"month\":4},{\"type\":\"treatment_systemic_change\",\"value\":\"Osimertinib dose reduced to 40mg daily due to grade 3 rash\",\"year\":2024,\"month\":4}]},\"other_cancers\":[{\"site\":\"breast, left\",\"year\":2015,\"month\":6,\"tnm_stage\":\"pT1cN0M0\",\"other_stage\":\"Stage I\",\"histopathology_status\":\"Grade 2 invasive ductal carcinoma\",\"biomarker_status\":\"ER positive (8/8), PR positive (6/8), HER2 negative\",\"latest_situation\":\"Disease free, completed 5 years of tamoxifen in 2020\"},{\"site\":\"melanoma right shoulder\",\"year\":2019,\"month\":8,\"tnm_stage\":\"pT2aN0M0\",\"other_stage\":\"Stage IB\",\"histopathology_status\":\"Breslow thickness 2.1mm, no ulceration\",\"biomarker_status\":\"BRAF V600E mutation not detected\",\"latest_situation\":\"Under annual surveillance with dermatology, no evidence of recurrence\"}],\"patient_facts\":[{\"type\":\"performance_status\",\"value\":\"ECOG PS 2 due to bone pain and fatigue\"},{\"type\":\"comorbidity\",\"value\":\"Type 1 diabetes with peripheral neuropathy\"},{\"type\":\"comorbidity\",\"value\":\"Chronic anxiety on regular medication\"},{\"type\":\"current_symptom\",\"value\":\"Right-sided chest pain requiring regular paracetamol and codeine\"},{\"type\":\"current_symptom\",\"value\":\"Breathlessness on minimal exertion\"},{\"type\":\"examination_finding\",\"value\":\"Reduced air entry right upper zone with percussion dullness\"},{\"type\":\"quality_of_life_finding\",\"value\":\"Requires walking frame due to bone pain affecting spine and left hip\"},{\"type\":\"investigation_finding\",\"value\":\"CT 15/03/24 shows partial response in primary mass, stable bone metastases\"}],\"status_updates\":[{\"type\":\"clinical_summary\",\"value\":\"Late stage breast cancer with widespread metastases. Partial response to Osimertinib with improving symptoms but treatment complicated by grade 3 rash requiring dose reduction\"},{\"type\":\"latest_treatment_response\",\"value\":\"30% reduction in size of primary tumor and reduction in bone pain following radiotherapy\"},{\"type\":\"latest_treatment_toxicity\",\"value\":\"Grade 3 papulopustular rash affecting >30% body surface area, requiring dose reduction and oral antibiotics\"},{\"type\":\"update_to_treatment\",\"value\":\"Continuing Osimertinib 40mg daily with improved tolerability following dose reduction\"},{\"type\":\"updated_patient_functional_status\",\"value\":\"Deterioration in mobility requiring increased care package and walking aids\"},{\"type\":\"planned_investigation\",\"value\":\"CT chest/abdomen/pelvis in 6 weeks to assess response\"},{\"type\":\"follow_up_referral\",\"value\":\"Review in lung oncology clinic in 2 weeks with blood results\"}]}}\n\nOutput Requirements:\n- Provide output in valid JSON format\n- Return only the response JSON, there is no need to return metadata or repeat the schema\n- Follow schema exactly\n- Do not create fields that are not in schema\n- Not all fields need to be present\n- Do not infer information not present in text\n- Preserve original clinical terminology, do not infer or standardise\n\nFinally - double check that cancer facts are accurate (including biomarker status), and double check that all cancer timeline and status updates have been extracted, in particular continuation or change in treatment. If provided prompt does not look like a cancer record, always respond with "The provided content is not related to cancer, and no content could be extracted", and DO NOT return a JSON. Importantly, do not hallucinate or infer information that is not present. \n\nThe letter will follow below."""

USER_MESSAGE = "MDM discussion 12/5/23- T2N2M0 distal oesophageal mass with mediastinal nodal involvement, initial assessment ?borderline resectable. For NACT\nEUS biopsy (15/6/23) - confirmed squamous cell carcinoma\nECF from 8/8/23, stopped after 1 cycle due to G3 mucositis and patient request. Multiple DNAs and poor engagement\n- Jan 24- PD in primary with new liver metastases. Consented for weekly paclitaxel\n- 15/2/24 oesophageal stent insertion\n- March 24 - commenced weekly paclitaxel, only received 2 doses - DNA, declined further Rx.\n\nCurrent situation - TC\nLast imaging 10/10/24 -CT CAP - progressive circumferential thickening of distal oesophagus measuring 4.5cm in length, previously 3.2cm. New mediastinal lymphadenopathy with largest node 2.8cm. Multiple new liver metastases, largest 3.4cm in segment 7. Moderate right pleural effusion. No evidence of peritoneal disease.\n\nDue F2F appointment but unable to attend due to social isolation and transport difficulties.\nMain symptomatic issues are dysphagia to solids and chest pain requiring oramorph prn (3-4x/week) and paracetamol.\n\nworsening fatigue\nNote last bloods 10/10 - Hb 88, mcv 82, alb 32\nNo peripheral oedema reported.\nPoor oral intake with documented weight loss and deconditioning\nInferred PS 3\n\nPlan\nAdvised to have repeat bloods with GP including iron studies - if iron deficient can commence oral iron\nNote last community palliative care review in Aug 24, will check ongoing involvement and request review.\nFor ongoing community follow-up + palliative care."

payload = {
    "model": "model",
    "messages": [
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "user", "content": USER_MESSAGE},
    ],
    "temperature": 0.0,
}

response = requests.post(url, headers=headers, data=json.dumps(payload))

print(json.dumps(response.json(), indent=2))

try:
    print("Model response:")
    print(response.json()["choices"][0]["message"]["content"])
except:
    print("Could not parse response content")
